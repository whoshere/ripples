<!-- 
	dropbox public linK
		https://dl.dropboxusercontent.com/u/40986170/ripple_test.html
	server link:  rr and rf  (ripples root and file)
		
	http:
	http://127.0.0.1:5723/




 * Water ripple effect.
 * Original code (Java) by Neil Wallis 
 * @link http://www.neilwallis.com/java/water.html
 * 
 * @author Sergey Chikuyonok (serge.che@gmail.com)
 http://media.chikuyonok.ru/ripple/ripple.js
 * @link http://chikuyonok.ru
joshua zz
 	http://www.lab4games.net/zz85/blog/2010/03/10/rain-water-ripples-with-html-canvas-javascript-jquery/
tom hammersley:
	http://www.gamedev.net/page/resources/_/technical/graphics-programming-and-theory/water-r718
hugo elias
	http://freespace.virgin.net/hugo.elias/graphics/x_water.htm
greek help?
 	http://users.softlab.ntua.gr/~ttsiod/wavePhysics.html
 	http://users.softlab.ntua.gr/~ttsiod/games.html
refraction physics classroom broken pencil:
	http://www.physicsclassroom.com/class/refrn/Lesson-1/Refraction-and-Sight

understanding sine wave 
	http://betterexplained.com/articles/intuitive-understanding-of-sine-waves/

 -->

<html>
<head>
	<title>ripple test</title>

<style>
 		@media  (min-device-width : 1010px) and (max-device-width : 1012px) {  /* miss asus*/
 			
 			#prompt { 
 				overflow-y: auto;  text-align:center;
 				margin: auto; display: block;
 				margin-top:4em; padding:1em;
 			}
 		}
 		
		
		#prompt {
			margin: auto; display: block; 
			margin-top:4em; padding:1em;
		}
		
		
 	</style>


<script> 
    //helper
    $ = function(id){return document.getElementById(id)};

    window.onload = function(){  
        var canvas = $('c'),
            /** @type {CanvasRenderingContext2D} */
            ctx = canvas.getContext('2d'),
            width = 900,  // image width 900
            height = 500, //500
            half_width = width >> 1,  //200
            half_height = height >> 1,  //200
            size = width * (height + 2) * 2,
            delay = 30,
            oldind = width,  //index!
            newind = width * (height + 3),
            riprad = 3,  //ripple radius (radius of finger)
            ripplemap = [],
            last_map = [],
            ripple,
            texture,
            //last three for drawing diagonal line-image on canvas:
            line_width = 20,
            step = line_width * 2, 
            count = height / line_width;
	    
//set size attribute on miss as
	var mq = window.matchMedia( "(min-device-width : 1010px) and (max-device-width : 1012px) )" );  //a  boolean
	if(mq) {
		$('prompt').size = '5';boo
	}

$('prompt').onchange = function(){
    this.style.display = 'none';  //works!        
      
    var img = new Image();
    img.onload = function() {
      	width = img.naturalWidth; // this will be img's actual width
    	height = img.naturalHeight; // this will be ...
    	canvas.width = width;
    	canvas.height =height
        ctx.drawImage(img, 0, 0,width,height);
    		/*
    					var radgrad = ctx.createRadialGradient(half_width,half_height,0,	 half_width,half_height,half_height);
    					radgrad.addColorStop(0, '#4af');
    					radgrad.addColorStop(1, '#000');

    					ctx.fillStyle = radgrad;
    					ctx.fillRect(0,0,width,height);	
    					
    					ctx.shadowColor = "white";
    					ctx.shadowOffsetX = 0;
    					ctx.shadowOffsetY = 0;
    					ctx.shadowBlur = 10;
    		


    					ctx.textBaseline = "top";
    					ctx.font = '42px verdana';
    					ctx.fillStyle = "white";  
    					ctx.textAlign = 'center';
    					ctx.fillText("Water Canvas", half_width, half_height-40);  	
    					ctx.font = '12px verdana';
    					ctx.fillText("touch canvas to move the water.", half_width, half_height+20); 
    					//ctx.fillText("By Almeros 2010, See http://code.almeros.com", 10, (this.height/2)+30);  	


    						        
    						    //canvas.width = img.width;
    						    //canvas.height = img.height;
    						    
    						    /*
    						     * Water ripple demo can work with any bitmap image
    						     * (see example here: http://media.chikuyonok.ru/ripple/)
    						     * But I need to draw simple artwork to bypass 1k limitation
    						     */
    						    // with (ctx) { //draws striped background
    						    //     fillStyle = '#a2ddf8'; //ligher blue
    						    //     fillRect(0, 0, width, height);
    						        
    						    //     fillStyle = '#07b'; //darker blue
    						    //     save();
    						    //     rotate(-0.785);
    						    //     for (var i = 0; i < count; i++) {
    						    //         fillRect(-width, i * step, width * 3, line_width);
    						    //     }
    						    //     restore();
    						    // }
    					///////////
    	texture = ctx.getImageData(0, 0, width, height);
    	ripple = ctx.getImageData(0, 0, width, height);
    };
    var name = $('prompt').value;
    img.src = 'images/' + name;
}
    //img.src =  "who0.png";   //'pebbles.jpg'; 320x240   "who0.png"  900x500
    //var name = prompt("Enter the name of the file", "pebbles.jpg   OR  who0.png");
    //img.src = 'images/' + name;

        //creates 2 arrays = height maps for ripples//here combined, so *2
            for (var i = 0; i < size; i++) {  //size = width * (height + 2) * 2
                last_map[i] = ripplemap[i] = 0;  //start without disturbances
            }
        
        /**
         * Main loop
         */
        function run() {
            newframe();
            ctx.putImageData(ripple, 0, 0);
        }
        
        /**
         * Disturb water at specified point
         each time there's s disturbance add 128 to radius:
         */
        function disturb(dx, dy) {  //eg mouse x/y
            dx <<= 0;  //make point coord  into an integer
            dy <<= 0;
            2
            for (var j = dy - riprad; j < dy + riprad; j++) {
                for (var k = dx - riprad; k < dx + riprad; k++) {
                    ripplemap[oldind + (j * width) + k] += 128;
                }
            }
        }  //adds 128 to all points in 'old' ripplemap around dx/dy since oldind = index of start of old map

        
        /**
         * Generates new ripples
         */
        function newframe() {
            var a, b, data, cur_pixel, new_pixel, old_data;

            //swap arrays
            var t = oldind; oldind = newind; newind = t;  //t=temporary

            
            
            // create local copies of variables to decrease
            // scope lookup time in Firefox
            var _width = width,
                _height = height,
                _ripplemap = ripplemap,
                _last_map = last_map,
                _rd = ripple.data,
                _td = texture.data,
                _half_width = half_width,
                _half_height = half_height;
            
            //populate new using old average
            var i = 0;  //index counter
            for (var y = 0; y < _height; y++) {
                for (var x = 0; x < _width; x++) {
                    var 	_newind = newind + i, 
                    		_mapind = oldind + i;
                    data = (   //height at old
                        _ripplemap[_mapind - _width] + 
                        _ripplemap[_mapind + _width] + 
                        _ripplemap[_mapind - 1] + 
                        _ripplemap[_mapind + 1]) >> 1;  //divide by 2
                        
                   data -= _ripplemap[_newind];
                  	data -= data >>5; //decay rate of disturbance: divide by 32  5,  9=wilder ride
                 
                    _ripplemap[_newind] = data;

                    //where data=0 then still, where data>0 then wave
                    data = 1024 - data;   //buffer has no data?
                
                    old_data = _last_map[i];
                    _last_map[i] = data;
                    
                    if (old_data != data) {
                        //offsets a/b = X/Y
                        a = (((x - _half_width) * data / 1024) << 0) + _half_width;
                        b = (((y - _half_height) * data / 1024) << 0) + _half_height;
        
                        //bounds check
                        if (a >= _width) a = _width - 1;
                        if (a < 0) a = 0;
                        if (b >= _height) b = _height - 1;
                        if (b < 0) b = 0;
        
                        new_pixel = (a + (b * _width)) * 4;
                        cur_pixel = i * 4;
                        
                        _rd[cur_pixel] = _td[new_pixel];
                        _rd[cur_pixel + 1] = _td[new_pixel + 1];
                        _rd[cur_pixel + 2] = _td[new_pixel + 2];
                    }
                    
                    ++i;
                }
            }
        }
        
        // canvas.onmousemove = function(/* Event */ evt) {
        //     disturb(evt.offsetX || evt.layerX, evt.offsetY || evt.layerY);
        // };

     	canvas.ontouchmove = function(event){
     	event.preventDefault();
     	disturb(event.touches[0].pageX, event.touches[0].pageY);
        }
     	

       
        
        setInterval(run, delay);
        
        // // generate random ripples
        // var rnd = Math.random;
        // setInterval(function() {
        //     disturb(rnd() * width, rnd() * height);
        // }, 700);   
    }
</script>
</head>
<body>
    <!-- the user is asked to select an image file -->
   <select id="prompt">
        <option style = 'background:none;'>Select an image:</option>
        <option></option>
        <option style = 'color: blue; padding-bottom:.5em;' >pebbles.jpg</option>
        <option  style = 'color: blue; padding-bottom:.5em;'>who0.png </option>
	<optgroup label=""></optgroup>
    </select>

	<canvas id = 'c' width = '500' height = '500' style = "display: block; margin: 0 auto;"></canvas>

</body>
</html>
